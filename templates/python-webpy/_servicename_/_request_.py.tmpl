<%
from tools.Service import DumpTree
import re
# Get requests by path
my_requests = {}
for request in requests:
    method = request['method']
    path = request['path']
    
    # Normalize path to a regexp
    path = re.sub('{[^}]+}', '[^/]+', path)
    my_requests.setdefault(path, []).append((method, request))

req_path = re.sub('{[^}]+}', '[^/]+', req['path'])
# Only get path params
req_path_params = filter(
    lambda param: param.startswith('{') and param.endswith('}'),
    re.split('({[^}]+})', req['path']))
req_path_params = ", ".join(map(lambda param: param[1:-1], req_path_params))

my_requests = my_requests[req_path]
methods = [request for request in my_requests]

def getStmValue(stm):
    return getValue({
        'value': stm.getChild(0).getText(),
        'type': stm.getText()})

def function_params(statement):
    params = [getStmValue(statement.getChild(i))
              for i in range(1, statement.getChildCount())]
    return ', '.join(params)

def cache_duration_in_secs(stm):
    type = stm.getChild(0).getText()
    value = int(stm.getChild(0).getChild(0).getText())
    if type == 'DURATION_MINUTES':
        return value * 60
    elif type == 'DURATION_HOURS':
        return value * 60 * 60
    elif type == 'DURATION_DAYS':
        return value * 60 * 60 * 24
    elif type == 'DURATION_MONTHS':
        return value * 60 * 60 * 24 * 30 # approc
    elif type == 'DURATION_YEARS':
        return value * 60 * 60 * 24 * 365
    else:
        return value

%>import re
import servicegen.function, servicegen.output

class ${req['name']}:
  % for method in methods:
    <% method_name, method_req = method %>
    def ${method_name}(self, ${req_path_params}):
        try:
          %for stm in req['statements']:
          %if stm.getText() == 'FUNCTION_CALL':
            <%
            function = stm.getChild(0).getChild(0).getText()
            if stm.getChild(0).getText() == 'FUNCTION_NAME_BUILTIN':
                function = 'servicegen.function.' + function
            %>${function}(${function_params(stm)})

          %elif stm.getText() == 'VARIABLE':
            <%
            identifier, value, cacheDuration, cacheKey = ('', '', 0, '')
            for i in range(stm.getChildCount()):
                child = stm.getChild(i)
                if child.getText() == 'VARTYPE':
                    # ignore
                    cacheKey += '_' + child.getChild(0).getText()
                    pass
                elif child.getText() == 'CACHE':
                    # caching
                    cacheDuration = cache_duration_in_secs(child)
                    cacheKey += '_' + str(cacheDuration)
                elif child.getText()[0:8] == 'LITERAL_':
                    value = getStmValue(child)
                    cacheKey += '_' + value
                else:
                    identifier = child.getText()
                    cacheKey += '_' + identifier
            cacheKey = re.sub('[^a-zA-Z_]', '', cacheKey).replace('__', '_')[1:]
            %>
            %if cacheDuration > 0:
            ${identifier} = servicegen.function.get_cache('${cacheKey}')
            if ${identifier} != None:
                 ${identifier} = ${value}
                 servicegen.function.set_cache('${cacheKey}', ${identifier})
            %else:
            ${identifier} = ${value}
            %endif
          %endif
          %endfor
        
          %for out_type, out in req['output'].iteritems():
            if servicegen.output.matches('${out_type}'):
                print "Outputting ${out_type}"
            
          %endfor
        
        except servicegen.function.TerminateRequest:
            # Ignore this exception
            return
  % endfor
